import React, { useState } from 'react';
import { MapContainer, TileLayer, Marker, Popup } from 'react-leaflet';
import { Card, CardHeader, CardTitle, CardContent, CardFooter } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Star } from 'lucide-react';

// Sample dining hall data
const diningHalls = [
  {
    id: 1,
    name: 'North Campus Dining',
    location: [42.2808, -83.7430],
    reviews: [
      { id: 1, rating: 4, text: 'Great variety of food options!', author: 'Student A' },
      { id: 2, rating: 3, text: 'Decent food, but can get crowded', author: 'Student B' }
    ],
    synopsis: 'Modern dining hall with multiple cuisine stations and dietary options.'
  },
  {
    id: 2,
    name: 'South Campus Dining',
    location: [42.2778, -83.7380],
    reviews: [
      { id: 1, rating: 5, text: 'Amazing salad bar and fresh ingredients', author: 'Student C' }
    ],
    synopsis: 'Spacious dining hall known for its healthy food choices.'
  }
];

// Review Component
const ReviewSection = ({ hall, onAddReview }) => {
  const [newReview, setNewReview] = useState('');
  const [rating, setRating] = useState(0);

  const handleSubmitReview = () => {
    if (newReview.trim() && rating > 0) {
      onAddReview(hall.id, {
        id: hall.reviews.length + 1,
        text: newReview,
        rating: rating,
        author: 'Anonymous'
      });
      setNewReview('');
      setRating(0);
    }
  };

  return (
    <Card className="w-full max-w-md mx-auto mt-4">
      <CardHeader>
        <CardTitle>{hall.name} Reviews</CardTitle>
      </CardHeader>
      <CardContent>
        <p className="mb-4">{hall.synopsis}</p>
        {hall.reviews.map(review => (
          <div key={review.id} className="mb-2 p-2 border rounded">
            <div className="flex items-center">
              {[...Array(review.rating)].map((_, i) => (
                <Star key={i} color="gold" fill="gold" size={16} />
              ))}
            </div>
            <p>{review.text}</p>
            <small className="text-gray-500">- {review.author}</small>
          </div>
        ))}
      </CardContent>
      <CardFooter>
        <div className="w-full">
          <div className="flex mb-2">
            {[1,2,3,4,5].map(num => (
              <Star 
                key={num} 
                color={num <= rating ? "gold" : "gray"} 
                fill={num <= rating ? "gold" : "none"} 
                size={24}
                onClick={() => setRating(num)}
                className="cursor-pointer"
              />
            ))}
          </div>
          <Textarea 
            placeholder="Write your review here..."
            value={newReview}
            onChange={(e) => setNewReview(e.target.value)}
            className="mb-2"
          />
          <Button onClick={handleSubmitReview}>Submit Review</Button>
        </div>
      </CardFooter>
    </Card>
  );
};

// Main App Component
const CampusDiningApp = () => {
  const [selectedHall, setSelectedHall] = useState(null);
  const [halls, setHalls] = useState(diningHalls);

  const addReview = (hallId, newReview) => {
    setHalls(prevHalls => 
      prevHalls.map(hall => 
        hall.id === hallId 
          ? {...hall, reviews: [...hall.reviews, newReview]} 
          : hall
      )
    );
  };

  return (
    <div className="flex flex-col items-center p-4">
      <h1 className="text-3xl font-bold mb-4">Campus Dining Hall Reviews</h1>
      
      <MapContainer 
        center={[42.2808, -83.7430]} 
        zoom={14} 
        scrollWheelZoom={false}
        className="h-[500px] w-full max-w-4xl"
      >
        <TileLayer
          url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
          attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        />
        {halls.map(hall => (
          <Marker 
            key={hall.id} 
            position={hall.location}
            eventHandlers={{
              click: () => setSelectedHall(hall),
            }}
          >
            <Popup>{hall.name}</Popup>
          </Marker>
        ))}
      </MapContainer>

      {selectedHall && (
        <ReviewSection 
          hall={selectedHall} 
          onAddReview={addReview}
        />
      )}
    </div>
  );
};

export default CampusDiningApp;
